name: "Deploy para VPS"
on:
    push:
        branches:
            - Desenv
jobs:
    build_deploy:
        runs-on: ubuntu-latest

        steps:
            - name: "Baixar o c√≥digo"
              uses: actions/checkout@v4

            - name: "Copiar arquivos para VPS"
              uses: appleboy/scp-action@v0.1.7
              with:
                host: "191.252.219.219"
                username: "root"
                password: ${{ secrets.SSH_PRIVATE_KEY }}
                source: "./index.html"
                target: "/teste"

            # Instalar o Docker
            - name: "Instalar Docker"
              run: |
                sudo apt-get update
                sudo apt-get install -y docker.io
                sudo systemctl start docker
                sudo systemctl enable docker

            - name: "Install sshpass"
              run: |
                sudo apt-get update
                sudo apt-get install -y sshpass

            # Copiar o arquivo appsettings.json do servidor remoto
            - name: "Copiar appsettings.json do servidor remoto"
              run: |
                  sshpass -p "${{ secrets.SFTP_PASSWORD }}" \
                  scp -o StrictHostKeyChecking=no \
                  ${{ secrets.SFTP_USERNAME }}@${{ secrets.SFTP_HOST }}:/var/www/api-back/config-api-back/appsettings.json ApiBlog/appsettings.json

            # Construir a imagem Docker
            - name: "Construir a imagem Docker"
              run: |
                  docker build -t imagem-api-blog ./ApiBlog

            # Salvar a imagem Docker como arquivo tar
            - name: "Salvar imagem Docker como arquivo tar"
              run: |
                  docker save -o imagem-api-blog-teste.tar imagem-api-blog

            # Transferir a imagem Docker para o servidor remoto
            - name: "Transferir imagem Docker para o servidor remoto"
              run: |
                  sshpass -p "${{ secrets.SFTP_PASSWORD }}" \
                  scp -o StrictHostKeyChecking=no imagem-api-blog-teste.tar \
                  ${{ secrets.SFTP_USERNAME }}@${{ secrets.SFTP_HOST }}:/var/www/api-back/imagem-api-back/