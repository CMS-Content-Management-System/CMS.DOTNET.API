name: "Deploy para VPS"
on:
    push:
        branches:
            - Desenv
jobs:
    build_deploy:
        runs-on: ubuntu-latest

        steps:
            - name: "Baixar o cÃ³digo"
              uses: actions/checkout@v4

            # Instalar o Docker
            - name: "Instalar Docker"
              run: |
                apt-get update
                apt-get install ca-certificates curl
                install -m 0755 -d /etc/apt/keyrings
                curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
                chmod a+r /etc/apt/keyrings/docker.asc
                echo \
                "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
                $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
                sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
                sudo apt-get update
                sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

            - name: "Install sshpass"
              run: |
                sudo apt-get update
                sudo apt-get install -y sshpass

            # Copiar o arquivo appsettings.json do servidor remoto
            - name: "Copiar appsettings.json do servidor remoto"
              run: |
                  sshpass -p "${{ secrets.SFTP_PASSWORD }}" \
                  scp -o StrictHostKeyChecking=no \
                  ${{ secrets.SFTP_USERNAME }}@${{ secrets.SFTP_HOST }}:/var/www/api-back/config-api-back/appsettings.json ApiBlog/appsettings.json

            # Construir a imagem Docker
            - name: "Construir a imagem Docker"
              run: |
                  docker build -t imagem-api-blog ./ApiBlog

            # Salvar a imagem Docker como arquivo tar
            - name: "Salvar imagem Docker como arquivo tar"
              run: |
                  docker save -o imagem-api-blog-teste.tar imagem-api-blog

            # Transferir a imagem Docker para o servidor remoto
            - name: "Transferir imagem Docker para o servidor remoto"
              run: |
                  sshpass -p "${{ secrets.SFTP_PASSWORD }}" \
                  scp -o StrictHostKeyChecking=no imagem-api-blog-teste.tar \
                  ${{ secrets.SFTP_USERNAME }}@${{ secrets.SFTP_HOST }}:/var/www/api-back/imagem-api-back/